{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    .font-size-controls {
        position: fixed;
        right: 15px;
        bottom: 15px;
        z-index: 1000;
        background-color: var(--bs-body-bg);
        border-radius: 50px;
        padding: 5px 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        opacity: 0.7;
        transition: opacity 0.3s;
    }
    
    .font-size-controls:hover {
        opacity: 1;
    }
    
    .font-size-controls button {
        background: none;
        border: none;
        color: var(--bs-body-color);
        font-size: 1.2rem;
        padding: 0 5px;
        cursor: pointer;
    }
    
    .font-size-controls .font-size-value {
        margin: 0 5px;
        min-width: 24px;
        text-align: center;
    }
    
    /* Enhanced table styles */
    .markdown-body table {
        width: 100%;
        margin-bottom: 1.5rem;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.09) !important;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .markdown-body table thead {
        background: linear-gradient(to bottom, var(--bs-primary), rgba(var(--bs-primary-rgb), 0.85));
        color: white;
        position: sticky;
        top: 0;
        z-index: 2;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .markdown-body table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.2) !important;
        position: relative;
        letter-spacing: 0.02em;
        transition: background-color 0.2s ease;
    }
    
    .markdown-body table td {
        padding: 12px 16px;
        border: 1px solid rgba(0,0,0,0.07) !important;
        vertical-align: top;
        transition: all 0.15s ease;
    }
    
    .markdown-body table tr:nth-child(even) {
        background-color: rgba(0,0,0,0.015);
    }
    
    .markdown-body table tr {
        transition: background-color 0.15s ease, transform 0.15s ease;
    }
    
    .markdown-body table tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.04);
        transform: translateY(-1px);
        box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        z-index: 1;
        position: relative;
    }
    
    .markdown-body table tr:hover td {
        border-color: rgba(var(--bs-primary-rgb), 0.15) !important;
    }
    
    /* For tables with borderless class */
    .markdown-body table.borderless th {
        border: none !important;
        border-bottom: 2px solid rgba(255,255,255,0.3) !important;
    }
    
    .markdown-body table.borderless td {
        border: none !important;
        border-bottom: 1px solid rgba(0,0,0,0.05) !important;
    }
    
    [data-bs-theme="dark"] .markdown-body table.borderless th {
        border: none !important;
        border-bottom: 2px solid rgba(255,255,255,0.2) !important;
    }
    
    [data-bs-theme="dark"] .markdown-body table.borderless td {
        border: none !important;
        border-bottom: 1px solid rgba(255,255,255,0.05) !important;
    }
    
    /* Add fixed width to make tables more consistent */
    .markdown-body table.fixed-layout {
        table-layout: fixed;
    }
    
    /* Sortable headers */
    .markdown-body table th.sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
        padding-right: 28px;
    }
    
    .markdown-body table th.sortable:hover {
        background-color: rgba(255,255,255,0.15);
    }
    
    .markdown-body table th .sort-icon {
        display: inline-block;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        font-size: 12px;
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }
    
    .markdown-body table th[data-sort-direction="asc"] .sort-icon,
    .markdown-body table th[data-sort-direction="desc"] .sort-icon {
        opacity: 1;
        color: rgba(255,255,255,0.9);
    }
    
    /* Table control panel */
    .table-controls {
        background-color: var(--bs-body-bg);
        border-radius: 10px 10px 0 0;
        padding: 10px 16px;
        border: 1px solid rgba(0,0,0,0.05);
        border-bottom: none;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
    }
    
    /* Table control buttons */
    .table-controls .btn-group .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 3px;
        border-radius: 6px;
        font-size: 0.85rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        transition: all 0.2s ease;
        padding: 6px 12px;
    }
    
    .table-controls .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    
    .table-controls .btn-group .btn:active {
        transform: translateY(0);
    }
    
    .table-controls .btn-group .btn i {
        margin-right: 5px;
        font-size: 0.9rem;
    }
    
    .table-controls .input-group {
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .table-controls .input-group-text {
        border-top-left-radius: 6px;
        border-bottom-left-radius: 6px;
        padding: 6px 12px;
    }
    
    .table-controls .input-group .form-control {
        border-top-right-radius: 6px;
        border-bottom-right-radius: 6px;
        border-color: rgba(0,0,0,0.1);
        font-size: 0.85rem;
        padding: 6px 12px;
    }
    
    .table-controls .input-group .form-control:focus {
        box-shadow: none;
        border-color: var(--bs-primary);
    }
    
    /* Full width table support */
    .table-fullwidth {
        max-width: 100vw;
        width: calc(100% + 40px);
        margin-left: -20px;
        margin-right: -20px;
        padding: 0 20px;
        transition: all 0.3s ease;
    }
    
    /* Custom table wrapper */
    .custom-table-wrapper {
        transition: all 0.3s ease;
        position: relative;
    }
    
    /* No results message */
    .no-results-message {
        font-size: 0.9rem;
    }
    
    /* Dark mode table styles */
    [data-bs-theme="dark"] .markdown-body table {
        border: 1px solid rgba(255,255,255,0.07) !important;
        box-shadow: 0 3px 15px rgba(0,0,0,0.15);
        background-color: rgba(255,255,255,0.02);
    }
    
    [data-bs-theme="dark"] .markdown-body table thead {
        background: linear-gradient(to bottom, var(--bs-primary), rgba(var(--bs-primary-rgb), 0.8));
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    
    [data-bs-theme="dark"] .markdown-body table th {
        color: white;
        border: 1px solid rgba(255,255,255,0.15) !important;
    }
    
    [data-bs-theme="dark"] .markdown-body table td {
        border: 1px solid rgba(255,255,255,0.06) !important;
    }
    
    [data-bs-theme="dark"] .markdown-body table tr:nth-child(even) {
        background-color: rgba(255,255,255,0.015);
    }
    
    [data-bs-theme="dark"] .markdown-body table tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    [data-bs-theme="dark"] .markdown-body table tr:hover td {
        border-color: rgba(var(--bs-primary-rgb), 0.2) !important;
    }
    
    /* Dark mode table controls */
    [data-bs-theme="dark"] .table-controls {
        background-color: var(--bs-body-bg);
        border: 1px solid rgba(255,255,255,0.07);
        border-bottom: none;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    }
    
    [data-bs-theme="dark"] .table-controls .input-group {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    [data-bs-theme="dark"] .table-controls .input-group .form-control {
        border-color: rgba(255,255,255,0.1);
        background-color: rgba(0,0,0,0.2);
        color: rgba(255,255,255,0.9);
    }
    
    [data-bs-theme="dark"] .table-controls .btn-group .btn {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Responsive tables for mobile */
    @media (max-width: 768px) {
        .markdown-body table {
            display: block;
            width: 100%;
            overflow-x: auto;
        }
        
        .markdown-body table thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .table-controls {
            overflow-x: auto;
        }
    }
    
    @media (orientation: landscape) and (max-width: 992px) {
        .font-size-controls {
            top: 15px;
            bottom: auto;
        }
        
        .document-title-container {
            margin-top: 50px;
        }
    }
    
    /* Mermaid diagram styles for dark mode */
    [data-bs-theme="dark"] .mermaid .node rect, 
    [data-bs-theme="dark"] .mermaid .node circle,
    [data-bs-theme="dark"] .mermaid .node ellipse,
    [data-bs-theme="dark"] .mermaid .node polygon,
    [data-bs-theme="dark"] .mermaid .node path {
        fill: #2d3748 !important;
        stroke: var(--bs-primary) !important;
    }

    [data-bs-theme="dark"] .mermaid .label {
        color: #e2e8f0 !important;
    }

    [data-bs-theme="dark"] .mermaid .edgeLabel {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }

    [data-bs-theme="dark"] .mermaid .edgePath .path,
    [data-bs-theme="dark"] .mermaid line {
        stroke: var(--bs-primary) !important;
    }

    /* Add hover effect to the whole table */
    .custom-table-wrapper:hover .markdown-body table {
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    /* Add alternating row colors for better readability */
    .markdown-body table tbody tr:nth-child(even) {
        background-color: rgba(0,0,0,0.015);
    }

    /* Add scroll indicator for wide tables */
    .table-responsive.custom-table-wrapper {
        position: relative;
    }

    .table-responsive.custom-table-wrapper::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 24px;
        background: linear-gradient(to right, rgba(255,255,255,0), rgba(0,0,0,0.05));
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 1;
    }

    .table-responsive.custom-table-wrapper.has-overflow::after {
        opacity: 1;
    }

    /* Dark mode enhancements */
    [data-bs-theme="dark"] .markdown-body table tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    [data-bs-theme="dark"] .table-responsive.custom-table-wrapper::after {
        background: linear-gradient(to right, rgba(0,0,0,0), rgba(255,255,255,0.05));
    }

    /* Add these list enhancement styles after the table styles */
    .markdown-body ul,
    .markdown-body ol {
        padding-left: 2rem;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .markdown-body ul {
        list-style-type: disc;
    }

    .markdown-body ul ul {
        list-style-type: circle;
    }

    .markdown-body ul ul ul {
        list-style-type: square;
    }

    .markdown-body ol {
        list-style-type: decimal;
        counter-reset: item;
        margin-left: 0;
        padding-left: 0;
    }

    .markdown-body ol > li {
        counter-increment: item;
        position: relative;
        padding-left: 2.25rem;
        margin-bottom: 0.6rem;
    }

    .markdown-body ol > li::before {
        content: counter(item) ".";
        position: absolute;
        left: 0.5rem;
        font-weight: 600;
        color: var(--bs-primary);
    }

    .markdown-body ol > li > strong:first-child,
    .markdown-body ol > li > p > strong:first-child {
        display: inline-block;
        color: var(--bs-primary);
        font-size: 1.15rem;
        margin-bottom: 0.25rem;
        font-weight: 700;
    }

    .markdown-body ol > li:nth-of-type(1),
    .markdown-body ol > li:nth-of-type(5),
    .markdown-body ol > li:nth-of-type(10),
    .markdown-body ol > li:nth-of-type(14) {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .markdown-body ol > li:nth-of-type(1):first-child {
        margin-top: 0;
    }

    .markdown-body ol > li:nth-of-type(n+2):nth-of-type(-n+4),
    .markdown-body ol > li:nth-of-type(n+6):nth-of-type(-n+9),
    .markdown-body ol > li:nth-of-type(n+11):nth-of-type(-n+13),
    .markdown-body ol > li:nth-of-type(n+15) {
        padding-left: 3.5rem;
    }

    .markdown-body ol > li:nth-of-type(n+2):nth-of-type(-n+4)::before,
    .markdown-body ol > li:nth-of-type(n+6):nth-of-type(-n+9)::before,
    .markdown-body ol > li:nth-of-type(n+11):nth-of-type(-n+13)::before,
    .markdown-body ol > li:nth-of-type(n+15)::before {
        left: 1.75rem;
    }

    .markdown-body ol > li > ol {
        margin-top: 0.5rem;
        margin-bottom: 0;
        counter-reset: subitem;
    }

    .markdown-body ol > li > ol > li {
        counter-increment: subitem;
        margin-bottom: 0.4rem;
        padding-left: 2.5rem;
    }

    .markdown-body ol > li > ol > li::before {
        content: counter(item) "." counter(subitem);
        left: 0.5rem;
    }

    /* Handle third level */
    .markdown-body ol > li > ol > li > ol {
        counter-reset: subsubitem;
        margin-top: 0.5rem;
    }

    .markdown-body ol > li > ol > li > ol > li {
        counter-increment: subsubitem;
        padding-left: 3rem;
    }

    .markdown-body ol > li > ol > li > ol > li::before {
        content: counter(item) "." counter(subitem) "." counter(subsubitem);
        left: 0.5rem;
    }

    /* Special styling for markdown headings followed by lists */
    .markdown-body h1 + ol,
    .markdown-body h2 + ol,
    .markdown-body h3 + ol {
        counter-reset: item;
        margin-top: 1.25rem;
    }

    /* Add more padding to paragraph content in list items for better readability */
    .markdown-body ol > li > p {
        margin-bottom: 0.5rem;
    }

    /* Fix for paragraphs containing strong elements in list items */
    .markdown-body ol > li > p:first-child {
        display: inline-block;
    }

    .markdown-body li {
        margin-bottom: 0.5rem;
        position: relative;
        transition: transform 0.15s ease;
    }

    .markdown-body li:hover {
        transform: translateX(2px);
    }

    .markdown-body li:last-child {
        margin-bottom: 0;
    }

    .markdown-body li > p {
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
    }

    /* Nested list spacing */
    .markdown-body li > ul,
    .markdown-body li > ol {
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
    }

    /* Custom bullets for unordered lists */
    .markdown-body ul li::marker {
        color: var(--bs-primary);
    }

    .markdown-body ul ul li::marker {
        color: rgba(var(--bs-primary-rgb), 0.8);
    }

    .markdown-body ul ul ul li::marker {
        color: rgba(var(--bs-primary-rgb), 0.6);
    }

    /* Custom number styling for ordered lists */
    .markdown-body ol li::marker {
        color: var(--bs-primary);
        font-weight: 600;
    }

    .markdown-body ol ol li::marker {
        color: rgba(var(--bs-primary-rgb), 0.8);
    }

    .markdown-body ol ol ol li::marker {
        color: rgba(var(--bs-primary-rgb), 0.6);
    }

    /* Task lists (checkboxes) */
    .markdown-body ul.contains-task-list {
        padding-left: 0.5rem;
        list-style-type: none;
    }

    .markdown-body ul.contains-task-list li {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 0.5rem;
    }

    .markdown-body ul.contains-task-list li input[type="checkbox"] {
        position: absolute;
        left: 0;
        top: 0.3rem;
        margin: 0;
        transform: scale(1.2);
        cursor: pointer;
    }

    .markdown-body ul.contains-task-list li.task-list-item-checked {
        color: #6c757d;
        text-decoration: line-through;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 576px) {
        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5rem;
        }
        
        .markdown-body li {
            margin-bottom: 0.75rem;
        }
        
        .markdown-body li > ul,
        .markdown-body li > ol {
            padding-left: 1.25rem;
        }
    }

    /* Dark mode specific adjustments */
    [data-bs-theme="dark"] .markdown-body ul li::marker {
        color: var(--bs-primary);
    }

    [data-bs-theme="dark"] .markdown-body ol li::marker {
        color: var(--bs-primary);
    }

    [data-bs-theme="dark"] .markdown-body ul.contains-task-list li.task-list-item-checked {
        color: #adb5bd;
    }

    /* Additional styles for nested ordered lists */
    .markdown-body ol ol {
        padding-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .markdown-body ol ol > li {
        padding-left: 2rem;
    }

    .markdown-body ol ol > li::before {
        left: 0.25rem;
    }

    /* Visual enhancement for design document structure */
    .markdown-body h2 + ol {
        margin-top: 1.5rem;
    }

    /* Strong text at beginning of list items */
    .markdown-body ol > li > strong {
        color: var(--bs-primary);
        font-weight: 600;
    }

    /* Design document specific styles */
    .markdown-body h1 + ol,
    .markdown-body h2 + ol,
    .markdown-body h3 + ol {
        counter-reset: section;
    }

    .markdown-body ol > li.section-header {
        font-weight: 600;
        font-size: 1.15rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: var(--bs-primary);
        padding-left: 0;
    }

    .markdown-body ol > li.section-header::before {
        content: none;
    }

    /* Fix for the section indentation and spacing */
    .markdown-body ol > li.section-item {
        padding-left: 3.5rem;
    }

    .markdown-body ol > li.section-item::before {
        left: 1.75rem;
    }

    /* Document structure list (like Design Document Components) */
    .markdown-body ol.document-structure {
        counter-reset: section;
        padding-left: 0.5rem;
    }

    .markdown-body ol.document-structure > li {
        position: relative;
        margin-bottom: 0.65rem;
        list-style: none;
        padding-left: 2.5rem;
    }

    .markdown-body ol.document-structure > li::before {
        content: counter(section) ".";
        counter-increment: section;
        position: absolute;
        left: 0.5rem;
        color: var(--bs-primary);
        font-weight: 600;
    }

    /* Section headers in document structure */
    .markdown-body ol.document-structure > li.section-header {
        margin-top: 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--bs-primary);
    }

    .markdown-body ol.document-structure > li.section-header::before {
        content: counter(section) ".";
        font-weight: 600;
    }

    /* Items under section headers */
    .markdown-body ol.document-structure > li.section-item {
        padding-left: 3.5rem;
    }

    .markdown-body ol.document-structure > li.section-item::before {
        left: 1.75rem;
    }

    /* Special formatting for key document sections */
    .markdown-body ol.document-structure > li.section-header:first-child,
    .markdown-body ol.document-structure > li:nth-child(5),
    .markdown-body ol.document-structure > li:nth-child(10),
    .markdown-body ol.document-structure > li:nth-child(14) {
        font-weight: 700;
        color: var(--bs-primary);
        margin-top: 1.75rem;
        margin-bottom: 0.75rem;
    }

    /* Better spacing for document structure lists */
    .markdown-body ol.document-structure {
        margin-top: 1.5rem;
    }

    /* Special styling for document structure headings */
    .markdown-body h1 + ol.document-structure,
    .markdown-body h2 + ol.document-structure {
        margin-top: 1.25rem;
    }

    /* Key document headings (like System Architecture, Detailed Design) */
    .markdown-body ol > li:first-child > p > strong:first-child,
    .markdown-body ol > li:nth-of-type(5) > p > strong:first-child,
    .markdown-body ol > li:nth-of-type(10) > p > strong:first-child,
    .markdown-body ol > li:nth-of-type(14) > p > strong:first-child {
        font-size: 1.25rem;
        color: var(--bs-primary);
        font-weight: 700;
        border-bottom: 2px solid rgba(var(--bs-primary-rgb), 0.2);
        padding-bottom: 0.25rem;
        display: inline-block;
        margin-bottom: 0.5rem;
    }

    /* Fix counter increments in Markdown rendering */
    .markdown-body ol {
        counter-reset: item;
    }

    .markdown-body ol > li {
        counter-increment: item;
    }

    /* Special handling for main list with document sections */
    .markdown-body > ol:first-of-type {
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block title %}{{ title.replace('-', ' ').title() }} - Study Buddy{% endblock %}

{% block content %}
<div class="document-title-container mb-4">
    <h1>{{ title.replace('-', ' ').title() }}</h1>
    <div class="subject-path text-muted">
        <a href="{{ url_for('index') }}">Home</a>
        {% if subject %}
         / <a href="{{ url_for('subject', subject=subject) }}">{{ subject.replace('-', ' ').title() }}</a> / 
        {{ title.replace('-', ' ').title() }}
        {% else %}
         / {{ title.replace('-', ' ').title() }}
        {% endif %}
    </div>
</div>

<div id="markdown-content" class="markdown-body">
    {{ content|safe }}
</div>

<div class="font-size-controls">
    <button id="decrease-font" aria-label="Decrease font size"><i class="fas fa-minus"></i></button>
    <span id="font-size-value" class="font-size-value">100%</span>
    <button id="increase-font" aria-label="Increase font size"><i class="fas fa-plus"></i></button>
</div>

<div id="mermaid-fallback-container" style="display: none;">
    <div class="alert alert-warning alert-dismissible fade show mt-4" role="alert">
        <strong><i class="fas fa-exclamation-triangle me-2"></i>Diagram rendering issue detected!</strong> Some complex diagrams may not render correctly.
        <button id="try-fallback" type="button" class="btn btn-sm btn-primary ms-3">
            <i class="fas fa-sync-alt me-1"></i>Try Alternative Renderer
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize mermaid with neutral theme
        mermaid.initialize({ theme: 'neutral' });
        
        // Force grid lines on tables
        function enforceTableGridLines() {
            console.log("Enforcing grid lines on tables");
            const style = document.createElement('style');
            style.textContent = `
                .markdown-body table {
                    border-collapse: separate !important;
                    border-spacing: 0 !important;
                    border-radius: 10px !important;
                    overflow: hidden !important;
                }
                .markdown-body table,
                .markdown-body table th,
                .markdown-body table td {
                    border-style: solid !important;
                    border-width: 1px !important;
                }
                .markdown-body table th {
                    border-color: rgba(255,255,255,0.2) !important;
                }
                .markdown-body table td {
                    border-color: rgba(0,0,0,0.07) !important;
                }
                [data-bs-theme="dark"] .markdown-body table {
                    border-color: rgba(255,255,255,0.07) !important;
                }
                [data-bs-theme="dark"] .markdown-body table th {
                    border-color: rgba(255,255,255,0.15) !important;
                }
                [data-bs-theme="dark"] .markdown-body table td {
                    border-color: rgba(255,255,255,0.06) !important;
                }
                .markdown-body table tr:last-child td {
                    border-bottom-width: 1px !important;
                }
                .markdown-body table td:first-child {
                    border-left-width: 1px !important;
                }
            `;
            document.head.appendChild(style);
            
            // Check if dark mode is active
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            // Also directly apply styles to all tables
            document.querySelectorAll('.markdown-body table').forEach(table => {
                table.style.borderCollapse = 'separate';
                table.style.borderSpacing = '0';
                table.style.borderRadius = '10px';
                table.style.overflow = 'hidden';
                
                if (isDarkMode) {
                    table.style.border = '1px solid rgba(255,255,255,0.07)';
                    
                    table.querySelectorAll('th').forEach(th => {
                        th.style.border = '1px solid rgba(255,255,255,0.15)';
                    });
                    
                    table.querySelectorAll('td').forEach(td => {
                        td.style.border = '1px solid rgba(255,255,255,0.06)';
                    });
                } else {
                    table.style.border = '1px solid rgba(0,0,0,0.09)';
                    
                    table.querySelectorAll('th').forEach(th => {
                        th.style.border = '1px solid rgba(255,255,255,0.2)';
                    });
                    
                    table.querySelectorAll('td').forEach(td => {
                        td.style.border = '1px solid rgba(0,0,0,0.07)';
                    });
                }
            });
            
            // Listen for theme changes and update styles accordingly
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'data-bs-theme') {
                        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                        document.querySelectorAll('.markdown-body table').forEach(table => {
                            if (isDarkMode) {
                                table.style.border = '1px solid rgba(255,255,255,0.07)';
                                
                                table.querySelectorAll('th').forEach(th => {
                                    th.style.border = '1px solid rgba(255,255,255,0.15)';
                                });
                                
                                table.querySelectorAll('td').forEach(td => {
                                    td.style.border = '1px solid rgba(255,255,255,0.06)';
                                });
                            } else {
                                table.style.border = '1px solid rgba(0,0,0,0.09)';
                                
                                table.querySelectorAll('th').forEach(th => {
                                    th.style.border = '1px solid rgba(255,255,255,0.2)';
                                });
                                
                                table.querySelectorAll('td').forEach(td => {
                                    td.style.border = '1px solid rgba(0,0,0,0.07)';
                                });
                            }
                        });
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });
        }
        
        // Call the enforce function after a slight delay to ensure DOM is fully processed
        setTimeout(enforceTableGridLines, 100);
        
        // Find all Mermaid diagrams and render them
        const diagrams = document.querySelectorAll('.mermaid');
        if (diagrams.length > 0) {
            diagrams.forEach((diagram, index) => {
                try {
                    // Add unique ID to each diagram for reference
                    if (!diagram.id) {
                        diagram.id = 'mermaid-diagram-' + index;
                    }
                } catch (error) {
                    console.error('Error rendering diagram', error);
                    // Create alert for rendering issues
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning mt-2';
                    alertDiv.innerHTML = 'There was an issue rendering this diagram. <button class="btn btn-sm btn-outline-secondary try-alt-renderer">Try alternate renderer</button>';
                    diagram.parentNode.insertBefore(alertDiv, diagram.nextSibling);
                    
                    // Add event listener to the button
                    alertDiv.querySelector('.try-alt-renderer').addEventListener('click', function() {
                        try {
                            const content = diagram.textContent;
                            diagram.innerHTML = '';
                            mermaid.render('mermaid-alt-' + index, content, function(svgCode) {
                                diagram.innerHTML = svgCode;
                                alertDiv.remove();
                            });
                        } catch (e) {
                            console.error('Alternative rendering failed', e);
                            alertDiv.innerHTML = 'All rendering methods failed. Please check the diagram syntax.';
                        }
                    });
                }
            });
        }
        
        // Table enhancements
        const tables = document.querySelectorAll('.markdown-body table');
        tables.forEach((table, tableIndex) => {
            // Add responsive wrapper and custom class
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive custom-table-wrapper mb-4';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
            table.classList.add('enhanced-table');
            table.id = 'table-' + tableIndex;
            
            // Determine if table should use fixed layout based on column count
            const headerCells = table.querySelectorAll('thead th').length;
            if (headerCells > 0 && headerCells <= 5) {
                table.classList.add('fixed-layout');
            }
            
            // Add control panel for tables with headers
            const tableHead = table.querySelector('thead');
            if (tableHead && tableHead.querySelectorAll('th').length > 0) {
                const controlPanel = document.createElement('div');
                controlPanel.className = 'table-controls mb-2 d-flex align-items-center flex-wrap';
                controlPanel.innerHTML = `
                    <div class="input-group input-group-sm me-2 mb-2" style="max-width: 250px;">
                        <span class="input-group-text bg-primary text-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control table-filter" placeholder="Filter table..." 
                            aria-label="Filter table" data-target="table-${tableIndex}">
                    </div>
                    <div class="btn-group me-2 mb-2" role="group" aria-label="Table controls">
                        <button class="btn btn-sm btn-outline-primary table-grid-btn" data-target="table-${tableIndex}" title="Hide grid lines">
                            <i class="fas fa-border-all"></i> Grid On
                        </button>
                        <button class="btn btn-sm btn-outline-primary table-layout-btn" data-target="table-${tableIndex}" title="Toggle fixed layout">
                            <i class="fas fa-columns"></i> Layout
                        </button>
                        <button class="btn btn-sm btn-outline-primary table-expand-btn" data-target="table-${tableIndex}" title="Expand to full width">
                            <i class="fas fa-expand-alt"></i> Width
                        </button>
                    </div>
                `;
                wrapper.insertBefore(controlPanel, table);
                
                // Make headers sortable
                const headers = tableHead.querySelectorAll('th');
                headers.forEach((header, index) => {
                    if (header.textContent.trim() !== '') {
                        header.classList.add('sortable');
                        header.setAttribute('data-sort-index', index);
                        header.setAttribute('data-sort-direction', 'none');
                        header.setAttribute('title', 'Click to sort');
                        header.innerHTML += ' <span class="sort-icon ms-1"></span>';
                        
                        header.addEventListener('click', function() {
                            sortTable(table, index, this);
                        });
                    }
                });
                
                // Add filter functionality
                const filterInput = controlPanel.querySelector('.table-filter');
                filterInput.addEventListener('input', function() {
                    filterTable(table, this.value);
                });
                
                // Add grid toggle functionality
                const gridBtn = controlPanel.querySelector('.table-grid-btn');
                gridBtn.classList.add('active');  // Mark as active by default
                gridBtn.classList.remove('btn-outline-primary');
                gridBtn.classList.add('btn-primary');  // Show as active by default
                
                gridBtn.addEventListener('click', function() {
                    const targetTable = document.getElementById(this.getAttribute('data-target'));
                    targetTable.classList.toggle('borderless');
                    
                    // Toggle button active state
                    if (targetTable.classList.contains('borderless')) {
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-secondary');
                        this.setAttribute('title', 'Show grid lines');
                        this.innerHTML = '<i class="fas fa-border-all"></i> Grid Off';
                        
                        // Apply borderless styles
                        const style = document.createElement('style');
                        style.id = `borderless-style-${tableIndex}`;
                        style.textContent = `
                            #table-${tableIndex}.borderless th,
                            #table-${tableIndex}.borderless td {
                                border: none !important;
                            }
                            #table-${tableIndex}.borderless th {
                                border-bottom: 1px solid rgba(255,255,255,0.2) !important;
                            }
                            #table-${tableIndex}.borderless td {
                                border-bottom: 1px solid rgba(0,0,0,0.05) !important;
                            }
                            [data-bs-theme="dark"] #table-${tableIndex}.borderless th {
                                border-bottom: 1px solid rgba(255,255,255,0.1) !important;
                            }
                            [data-bs-theme="dark"] #table-${tableIndex}.borderless td {
                                border-bottom: 1px solid rgba(255,255,255,0.05) !important;
                            }
                            #table-${tableIndex}.borderless tr:last-child td {
                                border-bottom: none !important;
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // Also apply inline styles for immediate effect
                        targetTable.querySelectorAll('th, td').forEach(cell => {
                            cell.style.border = 'none';
                        });
                        
                        targetTable.querySelectorAll('th').forEach(th => {
                            th.style.borderBottom = '1px solid rgba(255,255,255,0.2)';
                        });
                        
                        targetTable.querySelectorAll('td').forEach(td => {
                            td.style.borderBottom = '1px solid rgba(0,0,0,0.05)';
                        });
                        
                        // Check if dark mode
                        if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
                            targetTable.querySelectorAll('th').forEach(th => {
                                th.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                            });
                            
                            targetTable.querySelectorAll('td').forEach(td => {
                                td.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                            });
                        }
                        
                    } else {
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-primary');
                        this.setAttribute('title', 'Hide grid lines');
                        this.innerHTML = '<i class="fas fa-border-all"></i> Grid On';
                        
                        // Remove borderless styles
                        const style = document.getElementById(`borderless-style-${tableIndex}`);
                        if (style) style.remove();
                        
                        // Restore grid styles
                        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                        
                        if (isDarkMode) {
                            targetTable.querySelectorAll('th').forEach(th => {
                                th.style.border = '1px solid rgba(255,255,255,0.15)';
                            });
                            
                            targetTable.querySelectorAll('td').forEach(td => {
                                td.style.border = '1px solid rgba(255,255,255,0.06)';
                            });
                        } else {
                            targetTable.querySelectorAll('th').forEach(th => {
                                th.style.border = '1px solid rgba(255,255,255,0.2)';
                            });
                            
                            targetTable.querySelectorAll('td').forEach(td => {
                                td.style.border = '1px solid rgba(0,0,0,0.07)';
                            });
                        }
                    }
                });
                
                // Add layout toggle functionality
                const layoutBtn = controlPanel.querySelector('.table-layout-btn');
                layoutBtn.addEventListener('click', function() {
                    const targetTable = document.getElementById(this.getAttribute('data-target'));
                    targetTable.classList.toggle('fixed-layout');
                    
                    if (targetTable.classList.contains('fixed-layout')) {
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-outline-primary');
                    } else {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-outline-secondary');
                    }
                });
                
                // Add expand button functionality
                const expandBtn = controlPanel.querySelector('.table-expand-btn');
                expandBtn.addEventListener('click', function() {
                    const tableWrapper = document.getElementById(this.getAttribute('data-target')).closest('.table-responsive');
                    if (tableWrapper.classList.contains('table-fullwidth')) {
                        tableWrapper.classList.remove('table-fullwidth');
                        this.innerHTML = '<i class="fas fa-expand-alt"></i> Width';
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-outline-primary');
                    } else {
                        tableWrapper.classList.add('table-fullwidth');
                        this.innerHTML = '<i class="fas fa-compress-alt"></i> Width';
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-outline-secondary');
                    }
                });
            }
        });
        
        // Sort table function
        function sortTable(table, columnIndex, headerElement) {
            const sortDirection = headerElement.getAttribute('data-sort-direction');
            const newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            table.querySelectorAll('th').forEach(th => {
                th.setAttribute('data-sort-direction', 'none');
                th.querySelector('.sort-icon').textContent = '';
            });
            
            // Set current header
            headerElement.setAttribute('data-sort-direction', newDirection);
            headerElement.querySelector('.sort-icon').textContent = newDirection === 'asc' ? '↑' : '↓';
            
            // Get table rows and convert to array for sorting
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Sort rows
            rows.sort((a, b) => {
                const cellA = a.querySelectorAll('td')[columnIndex]?.textContent.trim() || '';
                const cellB = b.querySelectorAll('td')[columnIndex]?.textContent.trim() || '';
                
                // Check if content is numeric
                const isNumeric = !isNaN(cellA) && !isNaN(cellB);
                
                if (isNumeric) {
                    return newDirection === 'asc' 
                        ? parseFloat(cellA) - parseFloat(cellB)
                        : parseFloat(cellB) - parseFloat(cellA);
                } else {
                    return newDirection === 'asc'
                        ? cellA.localeCompare(cellB)
                        : cellB.localeCompare(cellA);
                }
            });
            
            // Remove existing rows and add sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Filter table function
        function filterTable(table, filterText) {
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const searchText = filterText.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show message if no results
            let noResultsMsg = table.nextElementSibling;
            if (noResultsMsg && noResultsMsg.classList.contains('no-results-message')) {
                noResultsMsg.remove();
            }
            
            const visibleRows = tbody.querySelectorAll('tr[style=""]').length;
            if (visibleRows === 0 && filterText.length > 0) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.className = 'alert alert-info mt-2 no-results-message';
                noResultsMsg.innerHTML = `No results found for "${filterText}"`;
                table.parentNode.insertBefore(noResultsMsg, table.nextSibling);
            }
        }
        
        // Font size controls
        const markdownContent = document.getElementById('markdown-content');
        const decreaseBtn = document.getElementById('decrease-font');
        const increaseBtn = document.getElementById('increase-font');
        const fontSizeValue = document.getElementById('font-size-value');
        
        let currentFontSize = 100;
        
        // Load saved font size from localStorage if available
        if (localStorage.getItem('markdownFontSize')) {
            currentFontSize = parseInt(localStorage.getItem('markdownFontSize'));
            updateFontSize();
        }
        
        function updateFontSize() {
            markdownContent.style.fontSize = currentFontSize + '%';
            fontSizeValue.textContent = currentFontSize + '%';
            localStorage.setItem('markdownFontSize', currentFontSize);
        }
        
        decreaseBtn.addEventListener('click', function() {
            if (currentFontSize > 70) {
                currentFontSize -= 10;
                updateFontSize();
            }
        });
        
        increaseBtn.addEventListener('click', function() {
            if (currentFontSize < 200) {
                currentFontSize += 10;
                updateFontSize();
            }
        });
        
        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            // Give browser time to update orientation
            setTimeout(function() {
                if (window.matchMedia("(orientation: landscape) and (max-width: 992px)").matches) {
                    document.querySelector('.document-title-container').classList.add('mt-5');
                } else {
                    document.querySelector('.document-title-container').classList.remove('mt-5');
                }
            }, 100);
        });

        // Check for table overflow to show scroll indicators
        function checkTableOverflow() {
            document.querySelectorAll('.table-responsive.custom-table-wrapper').forEach(wrapper => {
                if (wrapper.scrollWidth > wrapper.clientWidth) {
                    wrapper.classList.add('has-overflow');
                } else {
                    wrapper.classList.remove('has-overflow');
                }
            });
        }

        // Call on load and resize
        checkTableOverflow();
        window.addEventListener('resize', checkTableOverflow);

        // Add scroll event listener to show/hide scroll indicator
        document.querySelectorAll('.table-responsive.custom-table-wrapper').forEach(wrapper => {
            wrapper.addEventListener('scroll', function() {
                if (this.scrollLeft + this.clientWidth >= this.scrollWidth - 30) {
                    this.classList.remove('has-overflow');
                } else {
                    if (this.scrollWidth > this.clientWidth) {
                        this.classList.add('has-overflow');
                    }
                }
            });
        });

        // Add list structure detection after all other document processing
        // Detect and format document structure lists (like the Design Document Components)
        function enhanceDocumentStructureLists() {
            const contentDiv = document.getElementById('markdown-content');
            
            // Look for ordered lists that might be document structures
            contentDiv.querySelectorAll('ol').forEach(list => {
                // Check if this is a top-level list
                if (!list.closest('li')) {
                    const items = list.querySelectorAll('li');
                    if (items.length >= 8) { // Minimum items for a structured document
                        
                        // Check for patterns that suggest this is a structured document list
                        let isStructuredDocument = false;
                        let sectionHeaders = [];
                        
                        // Look for items that might be section headers (contain strong text or have significantly fewer words)
                        items.forEach((item, index) => {
                            const text = item.textContent.trim();
                            const words = text.split(/\s+/);
                            
                            // Check if item starts with a strong/bold text
                            const strongElem = item.querySelector('strong');
                            if (strongElem && strongElem.textContent.trim().length > 10) {
                                sectionHeaders.push(index);
                                isStructuredDocument = true;
                            }
                            // Or if item is short and followed by indented items
                            else if (words.length <= 5 && index < items.length - 1) {
                                // Check if next item appears to be indented or part of a section
                                const nextItem = items[index + 1];
                                if (nextItem && nextItem.textContent.trim().split(/\s+/).length > 5) {
                                    sectionHeaders.push(index);
                                    isStructuredDocument = true;
                                }
                            }
                        });
                        
                        if (isStructuredDocument) {
                            // Add classes for styling continuous numbering and sections
                            list.classList.add('document-structure');
                            
                            // Apply specific classes to section headers and their items
                            sectionHeaders.forEach((headerIndex, sectionIndex) => {
                                const sectionItem = items[headerIndex];
                                sectionItem.classList.add('section-header');
                                
                                // Get end of this section
                                const nextSectionIndex = sectionIndex < sectionHeaders.length - 1 ? 
                                    sectionHeaders[sectionIndex + 1] : items.length;
                                
                                // Mark items in this section
                                for (let i = headerIndex + 1; i < nextSectionIndex; i++) {
                                    if (items[i]) {
                                        items[i].classList.add('section-item');
                                    }
                                }
                            });
                            
                            // Add custom attribute to enable CSS targeting
                            list.setAttribute('data-structure-type', 'document');
                        }
                    }
                }
            });
        }

        // Call the function after the document is fully loaded
        setTimeout(enhanceDocumentStructureLists, 300);
    });
</script>

<style>
    .dark-mode .markdown-content {
        background-color: #2a2a2a;
        color: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
    }
    
    .dark-mode .markdown-content a {
        color: #79b8ff;
    }
    
    .dark-mode .markdown-content h1, 
    .dark-mode .markdown-content h2, 
    .dark-mode .markdown-content h3, 
    .dark-mode .markdown-content h4, 
    .dark-mode .markdown-content h5, 
    .dark-mode .markdown-content h6 {
        color: #98d8aa;
    }
    
    .dark-mode .markdown-content code {
        background-color: #3a3a3a;
        color: #ff7b72;
    }
    
    .dark-mode .markdown-content pre {
        background-color: #3a3a3a;
    }
    
    /* Ensure consistent mermaid diagram colors in dark mode */
    .dark-mode .mermaid .node rect,
    .dark-mode .mermaid .node circle,
    .dark-mode .mermaid .node polygon,
    .dark-mode .mermaid .node path {
        stroke: #98d8aa !important;
    }
    
    .dark-mode .mermaid .node.default > rect,
    .dark-mode .mermaid .node.default > circle,
    .dark-mode .mermaid .node.default > polygon {
        fill: #2a2a2a !important;
    }
    
    .dark-mode .mermaid .nodeLabel {
        color: #f0f0f0 !important;
    }
    
    .dark-mode .mermaid .edgePath .path {
        stroke: #98d8aa !important;
    }
    
    .dark-mode .mermaid .edgeLabel {
        background-color: #2a2a2a !important;
        color: #f0f0f0 !important;
    }
    
    .markdown-content {
        line-height: 1.7;
        transition: font-size 0.2s, background-color 0.3s, color 0.3s;
    }
    
    .reading-controls {
        transition: opacity 0.3s;
    }
</style>
{% endblock %} 